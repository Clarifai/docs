"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[4781],{59526:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>w,contentTitle:()=>v,default:()=>j,frontMatter:()=>x,metadata:()=>i,toc:()=>A});const i=JSON.parse('{"id":"integrations/DSPy/rag-dspy","title":"Building RAG with DSPy","description":"Learn how to build RAG with DSPy and  Clarifai Python SDK","source":"@site/docs/integrations/DSPy/rag-dspy.md","sourceDirName":"integrations/DSPy","slug":"/integrations/DSPy/rag-dspy","permalink":"/integrations/DSPy/rag-dspy","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"DSPy Modules & Signatures","permalink":"/integrations/DSPy/modules-signatures"},"next":{"title":"Multistage RAG Pipeline With DSPy","permalink":"/integrations/DSPy/multistage-dspy"}}');var a=t(74848),r=t(28453),s=t(65537),o=t(79329),l=t(58069);const c='# For the demo, we are using the "llama2-70b-chat" model from Clarifai\nMODEL_URL = "https://clarifai.com/meta/Llama-2/models/llama2-70b-chat" \n\n# PAT (Personal Access Token) provided by Clarifai for authentication\nPAT = "CLARIFAI_PAT"\n\n# User ID for authentication\nUSER_ID = "YOUR_ID"\n\n# App ID for authentication\nAPP_ID = "YOUR_APP"',d='# Import necessary modules from LangChain for text splitting, document loading, and Clarifai vector storage\nfrom langchain.text_splitter import CharacterTextSplitter\nfrom langchain.document_loaders import TextLoader\nfrom langchain.vectorstores import Clarifai as clarifaivectorstore\n\n# Initialize a TextLoader object with the path to the text file containing documents to ingest\nloader = TextLoader("/content/examples/RAG/data/Crawfords_Auto_Repair_Guide.txt") # Replace with your file path\n\n# Load documents using the loader\ndocuments = loader.load()\n\n# Set up a CharacterTextSplitter to split documents into smaller chunks for efficient processing\ntext_splitter = CharacterTextSplitter(chunk_size=1024, chunk_overlap=200)\n\n# Split documents into smaller chunks\ndocs = text_splitter.split_documents(documents)\n\n# Create a vector database using the Clarifai vector store\nclarifai_vector_db = clarifaivectorstore.from_documents(\n    user_id=USER_ID,  # User ID for authentication\n    app_id=APP_ID,    # App ID for authentication\n    documents=docs,   # Split documents\n    pat=PAT           # Personal Access Token (PAT) for authentication\n)',u="# Importing necessary modules\nimport dspy\nfrom dspy.retrieve.clarifai_rm import ClarifaiRM \n\n# Initializing the language model (LLM) with Clarifai\nllm = dspy.Clarifai(\n    model=MODEL_URL,             # Clarifai model URL\n    api_key=PAT,                 # Personal Access Token (PAT) for authentication\n    n=2,                         # Number of results to return\n    inference_params={           # Parameters for inference\n        \"max_tokens\": 100,       # Maximum number of tokens per input\n        'temperature': 0.6       # Temperature parameter for text generation\n    }\n)\n\n# Initializing the retriever model with Clarifai for document retrieval\nretriever_model = ClarifaiRM(\n    clarifai_user_id=USER_ID,    # User ID for Clarifai authentication\n    clarfiai_app_id=APP_ID,      # App ID for Clarifai authentication\n    clarifai_pat=PAT,            # PAT for Clarifai authentication\n    k=2                           # Number of documents to retrieve\n)\n\n# Configuring settings for DSPy\ndspy.settings.configure(\n    lm=llm,                      # Language model\n    rm=retriever_model           # Retriever model\n)",h="sentence = \"Fuel pump is broken\"\n\nclassify = dspy.Predict('sentence -> sentiment')\nprint(classify(sentence=sentence).sentiment)",p='# Defining a class named GenerateAnswer which inherits from dspy.Signature\nclass GenerateAnswer(dspy.Signature):\n    """Think and Answer questions based on the context provided."""\n\n    # Defining input fields with descriptions\n    context = dspy.InputField(desc="May contain relevant facts about user query")\n    question = dspy.InputField(desc="User query")\n    \n    # Defining output field with description\n    answer = dspy.OutputField(desc="Answer in one or two lines")\n',f="# Define a class named RAG inheriting from dspy.Module\nclass RAG(dspy.Module):\n    # Initialize the RAG class\n    def __init__(self):\n        # Call the superclass's constructor\n        super().__init__()\n\n        # Initialize the retrieve module\n        self.retrieve = dspy.Retrieve()\n        \n        # Initialize the generate_answer module using ChainOfThought with GenerateAnswer\n        self.generate_answer = dspy.ChainOfThought(GenerateAnswer)\n    \n    # Define the forward method\n    def forward(self, question):\n        # Retrieve relevant context passages based on the input question\n        context = self.retrieve(question).passages\n        \n        # Generate an answer based on the retrieved context and the input question\n        prediction = self.generate_answer(context=context, question=question)\n        \n        # Return the prediction as a dspy.Prediction object containing context and answer\n        return dspy.Prediction(context=context, answer=prediction.answer)\n",m='# Define the question to ask the RAG program\nmy_question = "How to change the brake fluid"\n\n# Create a RAG (Retrieval-Augmented Generation) object\nRag_obj = RAG()\n\n# Get the prediction from the RAG model for the given question.\n# This prediction includes both the context and the answer.\npredict_response_llama70b = Rag_obj(my_question)\n\n# Print the question, predicted answer, and truncated retrieved contexts.\nprint(f"Question: {my_question}")\nprint(f"Predicted Answer: {predict_response_llama70b.answer}")\nprint(f"Retrieved Contexts (truncated): {[c[:200] + \'...\' for c in predict_response_llama70b.context]}")',g='2024-04-09 13:14:16 INFO     clarifai.client.input:                                                    input.py:687\n\n                             Inputs Uploaded                                                                       \n\n                             code: SUCCESS                                                                         \n\n                             description: "Ok"                                                                     \n\n                             details: "All inputs successfully added"                                              \n\n                             req_id: "b5030582b50f20e6e78c52513cfa11dc"                                            \n\n                                                                                                                   \n\nINFO:clarifai.client.input:\n\nInputs Uploaded\n\ncode: SUCCESS\n\ndescription: "Ok"\n\ndetails: "All inputs successfully added"\n\nreq_id: "b5030582b50f20e6e78c52513cfa11dc"\n\n2024-04-09 13:14:18 INFO     clarifai.client.input:                                                    input.py:687\n\n                             Inputs Uploaded                                                                       \n\n                             code: SUCCESS                                                                         \n\n                             description: "Ok"                                                                     \n\n                             details: "All inputs successfully added"                                              \n\n                             req_id: "44ccf3fbb5b8932868a107658b5ce18e"                                            \n\n                                                                                                                   \n\nINFO:clarifai.client.input:\n\nInputs Uploaded\n\ncode: SUCCESS\n\ndescription: "Ok"\n\ndetails: "All inputs successfully added"\n\nreq_id: "44ccf3fbb5b8932868a107658b5ce18e"\n\n2024-04-09 13:14:20 INFO     clarifai.client.input:                                                    input.py:687\n\n                             Inputs Uploaded                                                                       \n\n                             code: SUCCESS                                                                         \n\n                             description: "Ok"                                                                     \n\n                             details: "All inputs successfully added"                                              \n\n                             req_id: "b8364c5c2a3a4b8d477f99b1028b6fec"                                            \n\n                                                                                                                   \n\nINFO:clarifai.client.input:\n\nInputs Uploaded\n\ncode: SUCCESS\n\ndescription: "Ok"\n\ndetails: "All inputs successfully added"\n\nreq_id: "b8364c5c2a3a4b8d477f99b1028b6fec"\n\n2024-04-09 13:14:21 INFO     clarifai.client.input:                                                    input.py:687\n\n                             Inputs Uploaded                                                                       \n\n                             code: SUCCESS                                                                         \n\n                             description: "Ok"                                                                     \n\n                             details: "All inputs successfully added"                                              \n\n                             req_id: "7c5d3751e0a79deae8012de213768932"                                            \n\n                                                                                                                   \n\nINFO:clarifai.client.input:\n\nInputs Uploaded\n\ncode: SUCCESS\n\ndescription: "Ok"\n\ndetails: "All inputs successfully added"\n\nreq_id: "7c5d3751e0a79deae8012de213768932"',y="NEGATIVE\n\nSentence: The car is running smoothly\n\nSentiment: POSITIVE\n\nSentence: The car is having some issues\n\nSentiment: NEUTRAL\n\nSentence: The car is amazing\n\nSentiment: POSITIVE\n\nSentence: The car is a lemon\n\nSentiment: NEGATIVE",b="Question: How to change the brake fluid\nPredicted Answer: Check the level of the brake fluid by looking at the markings on the reservoir. If the level is low, bring it to a mechanic.\nRetrieved Contexts (truncated): ['If you don t have the owner s manual for your car then you may be able to find one\\nonline by using Google or another search engine. Search the website for the make of\\nthe vehicle. You could also try y...', 'If you don t have the owner s manual for your car then you may be able to find one\\nonline by using Google or another search engine. Search the website for the make of\\nthe vehicle. You could also try y...']\n",x={sidebar_position:3},v="Building RAG with DSPy",w={},A=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Initialization",id:"initialization",level:2},{value:"Data Ingestion",id:"data-ingestion",level:2},{value:"Setup DSPy",id:"setup-dspy",level:2},{value:"RAG with DSPy",id:"rag-with-dspy",level:2},{value:"Chat",id:"chat",level:2}];function S(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components},{Details:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"building-rag-with-dspy",children:"Building RAG with DSPy"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Learn how to build RAG with DSPy and  Clarifai Python SDK"})}),"\n",(0,a.jsx)("hr",{}),"\n",(0,a.jsxs)(n.p,{children:["RAG systems combine two key functionalities: information retrieval and text generation. When you ask a question, RAG first retrieves relevant information (context) from a source like a document or database. Then, it uses that context to generate a well-informed and accurate answer. DSPy acts as your mission control for building RAG systems. It provides essential tools like modules and signatures to design and execute your program efficiently.\nClick ",(0,a.jsx)(n.a,{href:"https://www.clarifai.com/blog/what-is-rag-retrieval-augmented-generation",children:"here"})," to learn more about RAG."]}),"\n",(0,a.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Setting up the Clarifai Python SDK along with PAT. Refer to the installation and configuration with the PAT token ",(0,a.jsx)(n.a,{href:"https://docs.clarifai.com/python-sdk/sdk-overview/",children:"here"}),"."]}),"\n"]}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsxs)(n.p,{children:["Guide to get your ",(0,a.jsx)(n.a,{href:"https://docs.clarifai.com/clarifai-basics/authentication/personal-access-tokens",children:"PAT"})]})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Clone the Clarifai Examples repository to get the data files required for this example."}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"!git clone https://github.com/Clarifai/examples.git\n%cd /content/examples/\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Install the required packages."}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"!pip install clarifai\n!pip install langchain\n!pip install dspy-ai\n"})}),"\n",(0,a.jsx)(n.h2,{id:"initialization",children:"Initialization"}),"\n",(0,a.jsx)(n.p,{children:"The first part of creating a DSPy-Clarifai application is to set some initial fields. The variables should be configured correctly for authentication and model access."}),"\n",(0,a.jsx)(s.A,{groupId:"code",children:(0,a.jsx)(o.A,{value:"python",label:"Python",children:(0,a.jsx)(l.A,{className:"language-python",children:c})})}),"\n",(0,a.jsxs)(n.p,{children:["Here we are opting for llama2-70b-chat as the LLM Model. You can choose different LLM Models for the DSPy from Clarifai Community ",(0,a.jsx)(n.a,{href:"https://clarifai.com/explore/models?filterData=%5B%7B%22field%22%3A%22use_cases%22%2C%22value%22%3A%5B%22llm%22%5D%7D%5D&page=1&perPage=24",children:"Models"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"data-ingestion",children:"Data Ingestion"}),"\n",(0,a.jsx)(n.p,{children:"To use Clarifai as a retriever, the straightforward approach involves ingesting documents directly into the Clarifai app, which functions as your vector database. This enables easy retrieval of similar documents based on their vectors. To streamline this ingestion process, we've integrated the Clarifai vector database into our workflow. For this task, we will be using the Vehicle Repair Manual as data for DSPy."}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsx)(n.p,{children:"Langchain is required only for the data ingestion step, which you can skip if data has been already ingested through alternate methods."})}),"\n",(0,a.jsx)(s.A,{groupId:"code",children:(0,a.jsx)(o.A,{value:"python",label:"Python",children:(0,a.jsx)(l.A,{className:"language-python",children:d})})}),"\n",(0,a.jsxs)(t,{children:[(0,a.jsx)("summary",{children:"Output"}),(0,a.jsx)(l.A,{className:"language-python",children:g})]}),"\n",(0,a.jsx)(n.h2,{id:"setup-dspy",children:"Setup DSPy"}),"\n",(0,a.jsx)(n.p,{children:"In the next step we are going to initialize DSPy with an LLM model from the Clarifai platform, this showcases the flexibility Clarifai offers."}),"\n",(0,a.jsx)(s.A,{groupId:"code",children:(0,a.jsx)(o.A,{value:"python",label:"Python",children:(0,a.jsx)(l.A,{className:"language-python",children:u})})}),"\n",(0,a.jsx)(n.p,{children:"Before we move on to the next section let\u2019s do a test run,"}),"\n",(0,a.jsx)(s.A,{groupId:"code",children:(0,a.jsx)(o.A,{value:"python",label:"Python",children:(0,a.jsx)(l.A,{className:"language-python",children:h})})}),"\n",(0,a.jsxs)(t,{children:[(0,a.jsx)("summary",{children:"Output"}),(0,a.jsx)(l.A,{className:"language-python",children:y})]}),"\n",(0,a.jsx)(n.h2,{id:"rag-with-dspy",children:"RAG with DSPy"}),"\n",(0,a.jsx)(n.p,{children:'To construct a RAG module in DSPy effectively, you first need to define its signature. The signature explains the input and output fields succinctly, mapping from "question" to "answer" in a clear and intuitive manner. Once the signature is established, you proceed to create the module itself. A module in DSPy is where you put the signature into action, defining a specific functionality that compiles and generates responses based on the given queries. To begin, you construct a signature class, detailing the required input fields and the corresponding output fields. It\'s essential to provide comprehensive docstrings and descriptions within the class to ensure that the DSPy signature understands the context thoroughly and can compile the best prompt for the given use case. By following these steps, you can create robust and effective modules within DSPy, enabling seamless processing and response generation for various natural language processing tasks.'}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"GenerateAnswer"})," class is given below,"]}),"\n",(0,a.jsx)(s.A,{groupId:"code",children:(0,a.jsx)(o.A,{value:"python",label:"Python",children:(0,a.jsx)(l.A,{className:"language-python",children:p})})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"RAG"})," class is given below,"]}),"\n",(0,a.jsx)(s.A,{groupId:"code",children:(0,a.jsx)(o.A,{value:"python",label:"Python",children:(0,a.jsx)(l.A,{className:"language-python",children:f})})}),"\n",(0,a.jsx)(n.h2,{id:"chat",children:"Chat"}),"\n",(0,a.jsx)(n.p,{children:"In the final step, we are going to perform information retrieval using a Clarifai retriever based on factual evidence."}),"\n",(0,a.jsx)(s.A,{groupId:"code",children:(0,a.jsx)(o.A,{value:"python",label:"Python",children:(0,a.jsx)(l.A,{className:"language-python",children:m})})}),"\n",(0,a.jsxs)(t,{children:[(0,a.jsx)("summary",{children:"Output"}),(0,a.jsx)(l.A,{className:"language-python",children:b})]})]})}function j(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(S,{...e})}):S(e)}},65537:(e,n,t)=>{t.d(n,{A:()=>A});var i=t(96540),a=t(18215),r=t(65627),s=t(56347),o=t(50372),l=t(30604),c=t(11861),d=t(78749);function u(e){return i.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,i.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,i.useMemo)((()=>{const e=n??function(e){return u(e).map((e=>{let{props:{value:n,label:t,attributes:i,default:a}}=e;return{value:n,label:t,attributes:i,default:a}}))}(t);return function(e){const n=(0,c.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function p(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function f(e){let{queryString:n=!1,groupId:t}=e;const a=(0,s.W6)(),r=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,l.aZ)(r),(0,i.useCallback)((e=>{if(!r)return;const n=new URLSearchParams(a.location.search);n.set(r,e),a.replace({...a.location,search:n.toString()})}),[r,a])]}function m(e){const{defaultValue:n,queryString:t=!1,groupId:a}=e,r=h(e),[s,l]=(0,i.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const i=t.find((e=>e.default))??t[0];if(!i)throw new Error("Unexpected error: 0 tabValues");return i.value}({defaultValue:n,tabValues:r}))),[c,u]=f({queryString:t,groupId:a}),[m,g]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[a,r]=(0,d.Dv)(t);return[a,(0,i.useCallback)((e=>{t&&r.set(e)}),[t,r])]}({groupId:a}),y=(()=>{const e=c??m;return p({value:e,tabValues:r})?e:null})();(0,o.A)((()=>{y&&l(y)}),[y]);return{selectedValue:s,selectValue:(0,i.useCallback)((e=>{if(!p({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);l(e),u(e),g(e)}),[u,g,r]),tabValues:r}}var g=t(9136);const y={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=t(74848);function x(e){let{className:n,block:t,selectedValue:i,selectValue:s,tabValues:o}=e;const l=[],{blockElementScrollPositionUntilNextRender:c}=(0,r.a_)(),d=e=>{const n=e.currentTarget,t=l.indexOf(n),a=o[t].value;a!==i&&(c(n),s(a))},u=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const t=l.indexOf(e.currentTarget)+1;n=l[t]??l[0];break}case"ArrowLeft":{const t=l.indexOf(e.currentTarget)-1;n=l[t]??l[l.length-1];break}}n?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":t},n),children:o.map((e=>{let{value:n,label:t,attributes:r}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:i===n?0:-1,"aria-selected":i===n,ref:e=>{l.push(e)},onKeyDown:u,onClick:d,...r,className:(0,a.A)("tabs__item",y.tabItem,r?.className,{"tabs__item--active":i===n}),children:t??n},n)}))})}function v(e){let{lazy:n,children:t,selectedValue:r}=e;const s=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=s.find((e=>e.props.value===r));return e?(0,i.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:s.map(((e,n)=>(0,i.cloneElement)(e,{key:n,hidden:e.props.value!==r})))})}function w(e){const n=m(e);return(0,b.jsxs)("div",{className:(0,a.A)("tabs-container",y.tabList),children:[(0,b.jsx)(x,{...n,...e}),(0,b.jsx)(v,{...n,...e})]})}function A(e){const n=(0,g.A)();return(0,b.jsx)(w,{...e,children:u(e.children)},String(n))}},79329:(e,n,t)=>{t.d(n,{A:()=>s});t(96540);var i=t(18215);const a={tabItem:"tabItem_Ymn6"};var r=t(74848);function s(e){let{children:n,hidden:t,className:s}=e;return(0,r.jsx)("div",{role:"tabpanel",className:(0,i.A)(a.tabItem,s),hidden:t,children:n})}}}]);